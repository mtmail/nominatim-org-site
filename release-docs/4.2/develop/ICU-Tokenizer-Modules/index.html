<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://nominatim.org/develop/ICU-Tokenizer-Modules/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Custom modules for ICU tokenizer - Nominatim 4.2.4</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../extra.css" rel="stylesheet" />
        <link href="../../styles.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Custom modules for ICU tokenizer";
        var mkdocs_page_input_path = "develop/ICU-Tokenizer-Modules.md";
        var mkdocs_page_url = "/develop/ICU-Tokenizer-Modules/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Nominatim 4.2.4
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Search/">Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Reverse/">Reverse</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Lookup/">Address Lookup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Details/">Details</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Status/">Status</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Output/">Place Output Formats</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Faq/">FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Administration Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Installation/">Basic Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Import/">Import</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Update/">Update</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Deployment/">Deploy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Setup-Nominatim-UI/">Nominatim UI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Advanced-Installations/">Advanced Installations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Maintenance/">Maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Migration/">Migration from older Versions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Faq/">Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Customization Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Import-Styles/">Import Styles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Settings/">Configuration Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Country-Settings/">Per-Country Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Ranking/">Place Ranking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Importance/">Importance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Special-Phrases/">Special Phrases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tiger/">External data: US housenumbers from TIGER</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Postcodes/">External data: Postcodes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Architecture Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Database-Layout/">Database Layout</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Indexing/">Indexing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Custom modules for ICU tokenizer</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#using-non-standard-sanitizers-and-token-analyzers">Using non-standard sanitizers and token analyzers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#custom-sanitizer-modules">Custom sanitizer modules</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#sanitizer-configuration">Sanitizer configuration</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig">nominatim.tokenizer.sanitizers.config.SanitizerConfig</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_bool">get_bool()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_delimiter">get_delimiter()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_filter_kind">get_filter_kind()</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_string_list">get_string_list()</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#the-main-filter-function-of-the-sanitizer">The main filter function of the sanitizer</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#placeinfo-information-about-the-place">PlaceInfo - information about the place</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#placename-extended-naming-information">PlaceName - extended naming information</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example-filter-for-us-street-prefixes">Example: Filter for US street prefixes</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#custom-token-analysis-module">Custom token analysis module</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.AnalysisModule">nominatim.tokenizer.token_analysis.base.AnalysisModule</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.AnalysisModule.configure">configure()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.AnalysisModule.create">create()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.Analyzer">nominatim.tokenizer.token_analysis.base.Analyzer</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.Analyzer.compute_variants">compute_variants()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#nominatim.tokenizer.token_analysis.base.Analyzer.get_canonical_id">get_canonical_id()</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#example-creating-acronym-variants-for-long-names">Example: Creating acronym variants for long names</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sanitizers-vs-token-analysis-what-to-use-for-variants">Sanitizers vs. Token analysis - what to use for variants?</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Development-Environment/">Setup for Development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Testing/">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../data-sources/">External Data Sources</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-18/">Installation on Ubuntu 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-20/">Installation on Ubuntu 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-22/">Installation on Ubuntu 22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Nominatim 4.2.4</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Developers Guide &raquo;</li>
      <li>Custom modules for ICU tokenizer</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/openstreetmap/Nominatim/edit/master/docs/develop/ICU-Tokenizer-Modules.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="writing-custom-sanitizer-and-token-analysis-modules-for-the-icu-tokenizer">Writing custom sanitizer and token analysis modules for the ICU tokenizer<a class="headerlink" href="#writing-custom-sanitizer-and-token-analysis-modules-for-the-icu-tokenizer" title="Permanent link"></a></h1>
<p>The <a href="../../customize/Tokenizers/#icu-tokenizer">ICU tokenizer</a> provides a
highly customizable method to pre-process and normalize the name information
of the input data before it is added to the search index. It comes with a
selection of sanitizers and token analyzers which you can use to adapt your
installation to your needs. If the provided modules are not enough, you can
also provide your own implementations. This section describes the API
of sanitizers and token analysis.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This API is currently in early alpha status. While this API is meant to
be a public API on which other sanitizers and token analyzers may be
implemented, it is not guaranteed to be stable at the moment.</p>
</div>
<h2 id="using-non-standard-sanitizers-and-token-analyzers">Using non-standard sanitizers and token analyzers<a class="headerlink" href="#using-non-standard-sanitizers-and-token-analyzers" title="Permanent link"></a></h2>
<p>Sanitizer names (in the <code>step</code> property) and token analysis names (in the
<code>analyzer</code>) may refer to externally supplied modules. There are two ways
to include external modules: through a library or from the project directory.</p>
<p>To include a module from a library, use the absolute import path as name and
make sure the library can be found in your PYTHONPATH.</p>
<p>To use a custom module without creating a library, you can put the module
somewhere in your project directory and then use the relative path to the
file. Include the whole name of the file including the <code>.py</code> ending.</p>
<h2 id="custom-sanitizer-modules">Custom sanitizer modules<a class="headerlink" href="#custom-sanitizer-modules" title="Permanent link"></a></h2>
<p>A sanitizer module must export a single factory function <code>create</code> with the
following signature:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">SanitizerConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">ProcessInfo</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</code></pre></div>

<p>The function receives the custom configuration for the sanitizer and must
return a callable (function or class) that transforms the name and address
terms of a place. When a place is processed, then a <code>ProcessInfo</code> object
is created from the information that was queried from the database. This
object is sequentially handed to each configured sanitizer, so that each
sanitizer receives the result of processing from the previous sanitizer.
After the last sanitizer is finished, the resulting name and address lists
are forwarded to the token analysis module.</p>
<p>Sanitizer functions are instantiated once and then called for each place
that is imported or updated. They don't need to be thread-safe.
If multi-threading is used, each thread creates their own instance of
the function.</p>
<h3 id="sanitizer-configuration">Sanitizer configuration<a class="headerlink" href="#sanitizer-configuration" title="Permanent link"></a></h3>


<div class="doc doc-object doc-class">


<a id="nominatim.tokenizer.sanitizers.config.SanitizerConfig"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="nominatim.tokenizer.sanitizers.config._BaseUserDict">_BaseUserDict</span></code></p>

  
      <p>The <code>SanitizerConfig</code> class is a read-only dictionary
with configuration options for the sanitizer.
In addition to the usual dictionary functions, the class provides
accessors to standard sanitizer options that are used by many of the
sanitizers.</p>



  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_bool" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_bool</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_bool" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Extract a configuration parameter as a boolean.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>param</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the configuration parameter. The parameter must
   contain one of the yaml boolean values or an
   UsageError will be raised.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>default</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[bool]</code>
          </td>
          <td><p>Value to return, when the parameter is missing.
     When set to <code>None</code>, the parameter must be defined.</p></td>
          <td>
                <code>None</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>bool</code>
          </td>
          <td><p>Boolean value of the given parameter.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_delimiter" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_delimiter</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;,;&#39;</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_delimiter" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Return the 'delimiters' parameter in the configuration as a
compiled regular expression that can be used to split strings on
these delimiters.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>default</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Delimiters to be used when 'delimiters' parameter
     is not explicitly configured.</p></td>
          <td>
                <code>&#39;,;&#39;</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Pattern">Pattern</span>[str]</code>
          </td>
          <td><p>A regular expression pattern which can be used to</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Pattern">Pattern</span>[str]</code>
          </td>
          <td><p>split a string. The regular expression makes sure that the</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Pattern">Pattern</span>[str]</code>
          </td>
          <td><p>resulting names are stripped and that repeated delimiters</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Pattern">Pattern</span>[str]</code>
          </td>
          <td><p>are ignored. It may still create empty fields on occasion. The</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Pattern">Pattern</span>[str]</code>
          </td>
          <td><p>code needs to filter those.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_filter_kind" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_filter_kind</span><span class="p">(</span><span class="o">*</span><span class="n">default</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_filter_kind" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Return a filter function for the name kind from the 'filter-kind'
config parameter.</p>
<p>If the 'filter-kind' parameter is empty, the filter lets all items
pass. If the parameter is a string, it is interpreted as a single
regular expression that must match the full kind string.
If the parameter is a list then
any of the regular expressions in the list must match to pass.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>default</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Filters to be used, when the 'filter-kind' parameter
     is not specified. If omitted then the default is to
     let all names pass.</p></td>
          <td>
                <code>()</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Callable">Callable</span>[[str], bool]</code>
          </td>
          <td><p>A filter function which takes a name string and returns</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Callable">Callable</span>[[str], bool]</code>
          </td>
          <td><p>True when the item passes the filter.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_string_list" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_string_list</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">tuple</span><span class="p">())</span></code>

<a href="#nominatim.tokenizer.sanitizers.config.SanitizerConfig.get_string_list" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Extract a configuration parameter as a string list.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>param</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>Name of the configuration parameter.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>default</code></td>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>Value to return, when the parameter is missing.</p></td>
          <td>
                <code>tuple()</code>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>If the parameter value is a simple string, it is returned as a</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>one-item list. If the parameter value does not exist, the given</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>default is returned. If the parameter value is a list, it is</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Sequence">Sequence</span>[str]</code>
          </td>
          <td><p>checked to contain only strings before being returned.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>



  </div>

  </div>

</div><h3 id="the-main-filter-function-of-the-sanitizer">The main filter function of the sanitizer<a class="headerlink" href="#the-main-filter-function-of-the-sanitizer" title="Permanent link"></a></h3>
<p>The filter function receives a single object of type <code>ProcessInfo</code>
which has with three members:</p>
<ul>
<li><code>place</code>: read-only information about the place being processed.
   See PlaceInfo below.</li>
<li><code>names</code>: The current list of names for the place. Each name is a
   PlaceName object.</li>
<li><code>address</code>: The current list of address names for the place. Each name
   is a PlaceName object.</li>
</ul>
<p>While the <code>place</code> member is provided for information only, the <code>names</code> and
<code>address</code> lists are meant to be manipulated by the sanitizer. It may add and
remove entries, change information within a single entry (for example by
adding extra attributes) or completely replace the list with a different one.</p>
<h4 id="placeinfo-information-about-the-place">PlaceInfo - information about the place<a class="headerlink" href="#placeinfo-information-about-the-place" title="Permanent link"></a></h4>


<div class="doc doc-object doc-class">


<a id="nominatim.data.place_info.PlaceInfo"></a>
  <div class="doc doc-contents first">

  
      <p>This data class contains all information the tokenizer can access
about a place.</p>



  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h6 id="nominatim.data.place_info.PlaceInfo.address" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#nominatim.data.place_info.PlaceInfo.address" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>A dictionary with the address elements of the place. They key
usually corresponds to the suffix part of the key of an OSM
'addr:<em>' or 'isin:</em>' tag. There are also some special keys like
<code>country</code> or <code>country_code</code> which merge OSM keys that contain
the same information. See <a href="../../customize/Import-Styles/">Import Styles</a> for details.</p>
<p>The property may be None if the place has no address information.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="nominatim.data.place_info.PlaceInfo.centroid" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">centroid</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#nominatim.data.place_info.PlaceInfo.centroid" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>A center point of the place in WGS84. May be None when the
geometry of the place is unknown.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="nominatim.data.place_info.PlaceInfo.country_code" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">country_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#nominatim.data.place_info.PlaceInfo.country_code" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>The country code of the country the place is in. Guaranteed
to be a two-letter lower-case string. If the place is not inside
any country, the property is set to None.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="nominatim.data.place_info.PlaceInfo.name" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#nominatim.data.place_info.PlaceInfo.name" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>A dictionary with the names of the place. Keys and values represent
the full key and value of the corresponding OSM tag. Which tags
are saved as names is determined by the import style.
The property may be None if the place has no names.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">



<h6 id="nominatim.data.place_info.PlaceInfo.rank_address" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">rank_address</span><span class="p">:</span> <span class="nb">int</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#nominatim.data.place_info.PlaceInfo.rank_address" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>The <a href="../../customize/Ranking/#address-rank">rank address</a> before ant rank correction is applied.</p>
  </div>

</div>



<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_info.PlaceInfo.is_a" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">is_a</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

<a href="#nominatim.data.place_info.PlaceInfo.is_a" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Set to True when the place's primary tag corresponds to the given
key and value.</p>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_info.PlaceInfo.is_country" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">is_country</span><span class="p">()</span></code>

<a href="#nominatim.data.place_info.PlaceInfo.is_country" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Set to True when the place is a valid country boundary.</p>

  </div>

</div>



  </div>

  </div>

</div><h4 id="placename-extended-naming-information">PlaceName - extended naming information<a class="headerlink" href="#placename-extended-naming-information" title="Permanent link"></a></h4>


<div class="doc doc-object doc-class">


<a id="nominatim.data.place_name.PlaceName"></a>
  <div class="doc doc-contents first">

  
      <p>Each name and address part of a place is encapsulated in an object of
this class. It saves not only the name proper but also describes the
kind of name with two properties:</p>
<ul>
<li><code>kind</code> describes the name of the OSM key used without any suffixes
  (i.e. the part after the colon removed)</li>
<li><code>suffix</code> contains the suffix of the OSM tag, if any. The suffix
  is the part of the key after the first colon.</li>
</ul>
<p>In addition to that, a name may have arbitrary additional attributes.
How attributes are used, depends on the sanitizers and token analysers.
The exception is is the 'analyzer' attribute. This attribute determines
which token analysis module will be used to finalize the treatment of
names.</p>



  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_name.PlaceName.clone" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">clone</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#nominatim.data.place_name.PlaceName.clone" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Create a deep copy of the place name, optionally with the
given parameters replaced. In the attribute list only the given
keys are updated. The list is not replaced completely.
In particular, the function cannot to be used to remove an
attribute from a place name.</p>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_name.PlaceName.get_attr" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#nominatim.data.place_name.PlaceName.get_attr" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Return the given property or the value of 'default' if it
is not set.</p>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_name.PlaceName.has_attr" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">has_attr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span></code>

<a href="#nominatim.data.place_name.PlaceName.has_attr" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Check if the given attribute is set.</p>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.data.place_name.PlaceName.set_attr" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">set_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

<a href="#nominatim.data.place_name.PlaceName.set_attr" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Add the given property to the name. If the property was already
set, then the value is overwritten.</p>

  </div>

</div>



  </div>

  </div>

</div><h3 id="example-filter-for-us-street-prefixes">Example: Filter for US street prefixes<a class="headerlink" href="#example-filter-for-us-street-prefixes" title="Permanent link"></a></h3>
<p>The following sanitizer removes the directional prefixes from street names
in the US:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">_filter_function</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">place</span><span class="o">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="s1">&#39;us&#39;</span> \
       <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">place</span><span class="o">.</span><span class="n">rank_address</span> <span class="o">&gt;=</span> <span class="mi">26</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">place</span><span class="o">.</span><span class="n">rank_address</span> <span class="o">&lt;=</span> <span class="mi">27</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
            <span class="n">name</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(north|south|west|east) &#39;</span><span class="p">,</span>
                               <span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_filter_function</span>
</code></pre></div>

<p>This is the most simple form of a sanitizer module. If defines a single
filter function and implements the required <code>create()</code> function by returning
the filter.</p>
<p>The filter function first checks if the object is interesting for the
sanitizer. Namely it checks if the place is in the US (through <code>country_code</code>)
and it the place is a street (a <code>rank_address</code> of 26 or 27). If the
conditions are met, then it goes through all available names and
removes any leading directional prefix using a simple regular expression.</p>
<p>Save the source code in a file in your project directory, for example as
<code>us_streets.py</code>. Then you can use the sanitizer in your <code>icu_tokenizer.yaml</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="nn">...</span>
<span class="nt">sanitizers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us_streets.py</span>
<span class="nn">...</span>
</code></pre></div>

<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This example is just a simplified show case on how to create a sanitizer.
It is not really read for real-world use: while the sanitizer would
correcly transform <code>West 5th Street</code> into <code>5th Street</code>. it would also
shorten a simple <code>North Street</code> to <code>Street</code>.</p>
</div>
<p>For more sanitizer examples, have a look at the sanitizers provided by Nominatim.
They can be found in the directory
<a href="https://github.com/osm-search/Nominatim/tree/master/nominatim/tokenizer/sanitizers"><code>nominatim/tokenizer/sanitizers</code></a>.</p>
<h2 id="custom-token-analysis-module">Custom token analysis module<a class="headerlink" href="#custom-token-analysis-module" title="Permanent link"></a></h2>


<div class="doc doc-object doc-class">


<a id="nominatim.tokenizer.token_analysis.base.AnalysisModule"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="nominatim.typing.Protocol">Protocol</span></code></p>

  
      <p>The setup of the token analysis is split into two parts:
configuration and analyser factory. A token analysis module must
therefore implement the two functions here described.</p>



  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.token_analysis.base.AnalysisModule.configure" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">configure</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">normalizer</span><span class="p">,</span> <span class="n">transliterator</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.token_analysis.base.AnalysisModule.configure" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Prepare the configuration of the analysis module.
This function should prepare all data that can be shared
between instances of this analyser.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>rules</code></td>
          <td>
                <code><span title="typing.Mapping">Mapping</span>[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td><p>A dictionary with the additional configuration options
   as specified in the tokenizer configuration.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>normalizer</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>an ICU Transliterator with the compiled
        global normalization rules.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transliterator</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>an ICU Transliterator with the compiled
            global transliteration rules.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>A data object with configuration data. This will be handed</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>as is into the <code>create()</code> function and may be</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>used freely by the analysis module as needed.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.token_analysis.base.AnalysisModule.create" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">create</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">transliterator</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.token_analysis.base.AnalysisModule.create" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Create a new instance of the analyser.
A separate instance of the analyser is created for each thread
when used in multi-threading context.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>normalizer</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>an ICU Transliterator with the compiled normalization
        rules.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transliterator</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>an ICU Transliterator with the compiled
            transliteration rules.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>config</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td><p>The object that was returned by the call to configure().</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="nominatim.tokenizer.token_analysis.base.Analyzer" href="#nominatim.tokenizer.token_analysis.base.Analyzer">Analyzer</a></code>
          </td>
          <td><p>A new analyzer instance. This must be an object that implements</p></td>
        </tr>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="nominatim.tokenizer.token_analysis.base.Analyzer" href="#nominatim.tokenizer.token_analysis.base.Analyzer">Analyzer</a></code>
          </td>
          <td><p>the Analyzer protocol.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">


<a id="nominatim.tokenizer.token_analysis.base.Analyzer"></a>
  <div class="doc doc-contents first">
      <p class="doc doc-class-bases">
        Bases: <code><span title="nominatim.typing.Protocol">Protocol</span></code></p>

  
      <p>The <code>create()</code> function of an analysis module needs to return an
object that implements the following functions.</p>



  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.token_analysis.base.Analyzer.compute_variants" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">compute_variants</span><span class="p">(</span><span class="n">canonical_id</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.token_analysis.base.Analyzer.compute_variants" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Compute the transliterated spelling variants for the given
canonical ID.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>canonical_id</code></td>
          <td>
                <code>str</code>
          </td>
          <td><p>ID string previously computed with
          <code>get_canonical_id()</code>.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>A list of possible spelling variants. All strings must have</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>been transformed with the global normalizer and</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>transliterator ICU rules. Otherwise they cannot be matched</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>against the input by the query frontend.</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>The list may be empty, when there are no useful</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>spelling variants. This may happen when an analyzer only</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>usually outputs additional variants to the canonical spelling</p></td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.List">List</span>[str]</code>
          </td>
          <td><p>and there are no such variants.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>

<div class="doc doc-object doc-function">



<h6 id="nominatim.tokenizer.token_analysis.base.Analyzer.get_canonical_id" class="doc doc-heading">
<code class="codehilite language-python"><span class="n">get_canonical_id</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#nominatim.tokenizer.token_analysis.base.Analyzer.get_canonical_id" class="headerlink" title="Permanent link"></a></h6>


  <div class="doc doc-contents ">
  
      <p>Return the canonical form of the given name. The canonical ID must
be unique (the same ID must always yield the same variants) and
must be a form from which the variants can be derived.</p>

  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="nominatim.data.place_name.PlaceName" href="#nominatim.data.place_name.PlaceName">PlaceName</a></code>
          </td>
          <td><p>Extended place name description as prepared by
  the sanitizers.</p></td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td><p>ID string with a canonical form of the name. The string may</p></td>
        </tr>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td><p>be empty, when the analyzer cannot analyze the name at all,</p></td>
        </tr>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td><p>for example because the character set in use does not match.</p></td>
        </tr>
    </tbody>
  </table>

  </div>

</div>



  </div>

  </div>

</div><h3 id="example-creating-acronym-variants-for-long-names">Example: Creating acronym variants for long names<a class="headerlink" href="#example-creating-acronym-variants-for-long-names" title="Permanent link"></a></h3>
<p>The following example of a token analysis module creates acronyms from
very long names and adds them as a variant:</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span> <span class="nc">AcronymMaker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This class is the actual analyzer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">norm</span><span class="p">,</span> <span class="n">trans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">norm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span>


    <span class="k">def</span> <span class="nf">get_canonical_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># In simple cases, the normalized name can be used as a canonical id.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">transliterate</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">compute_variants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># The transliterated form of the name always makes up a variant.</span>
        <span class="n">variants</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">transliterate</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>

        <span class="c1"># Only create acronyms from very long words.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="c1"># Take the first letter from each word to form the acronym.</span>
            <span class="n">acronym</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="c1"># If that leds to an acronym with at least three letters,</span>
            <span class="c1"># add the resulting acronym as a variant.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acronym</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Never forget to transliterate the variants before returning them.</span>
                <span class="n">variants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trans</span><span class="o">.</span><span class="n">transliterate</span><span class="p">(</span><span class="n">acronym</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">variants</span>

<span class="c1"># The following two functions are the module interface.</span>

<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">normalizer</span><span class="p">,</span> <span class="n">transliterator</span><span class="p">):</span>
    <span class="c1"># There is no configuration to parse and no data to set up.</span>
    <span class="c1"># Just return an empty configuration.</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">transliterator</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="c1"># Return a new instance of our token analysis class above.</span>
    <span class="k">return</span> <span class="n">AcronymMaker</span><span class="p">(</span><span class="n">normalizer</span><span class="p">,</span> <span class="n">transliterator</span><span class="p">)</span>
</code></pre></div>

<p>Given the name <code>Trans-Siberian Railway</code>, the code above would return the full
name <code>Trans-Siberian Railway</code> and the acronym <code>TSR</code> as variant, so that
searching would work for both.</p>
<h2 id="sanitizers-vs-token-analysis-what-to-use-for-variants">Sanitizers vs. Token analysis - what to use for variants?<a class="headerlink" href="#sanitizers-vs-token-analysis-what-to-use-for-variants" title="Permanent link"></a></h2>
<p>It is not always clear when to implement variations in the sanitizer and
when to write a token analysis module. Just take the acronym example
above: it would also have been possible to write a sanitizer which adds the
acronym as an additional name to the name list. The result would have been
similar. So which should be used when?</p>
<p>The most important thing to keep in mind is that variants created by the
token analysis are only saved in the word lookup table. They do not need
extra space in the search index. If there are many spelling variations, this
can mean quite a significant amount of space is saved.</p>
<p>When creating additional names with a sanitizer, these names are completely
independent. In particular, they can be fed into different token analysis
modules. This gives a much greater flexibility but at the price that the
additional names increase the size of the search index.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../Tokenizers/" class="btn btn-neutral float-left" title="Tokenizers"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Development-Environment/" class="btn btn-neutral float-right" title="Setup for Development">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/openstreetmap/Nominatim" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../Tokenizers/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Development-Environment/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
