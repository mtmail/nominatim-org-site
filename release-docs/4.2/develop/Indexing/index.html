<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://nominatim.org/develop/Indexing/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Indexing - Nominatim 4.2.4</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet" />
        <link href="../../extra.css" rel="stylesheet" />
        <link href="../../styles.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Indexing";
        var mkdocs_page_input_path = "develop/Indexing.md";
        var mkdocs_page_url = "/develop/Indexing/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Nominatim 4.2.4
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Introduction</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">API Reference</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Search/">Search</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Reverse/">Reverse</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Lookup/">Address Lookup</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Details/">Details</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Status/">Status</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Output/">Place Output Formats</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../api/Faq/">FAQ</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Administration Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Installation/">Basic Installation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Import/">Import</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Update/">Update</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Deployment/">Deploy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Setup-Nominatim-UI/">Nominatim UI</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Advanced-Installations/">Advanced Installations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Maintenance/">Maintenance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Migration/">Migration from older Versions</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../admin/Faq/">Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Customization Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Import-Styles/">Import Styles</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Settings/">Configuration Settings</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Country-Settings/">Per-Country Data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Ranking/">Place Ranking</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Importance/">Importance</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Special-Phrases/">Special Phrases</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Tiger/">External data: US housenumbers from TIGER</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../customize/Postcodes/">External data: Postcodes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers Guide</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Architecture Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Database-Layout/">Database Layout</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Indexing</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#initial-import">Initial import</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#indexing">Indexing</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#data-preparation">Data preparation</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#addr-tag-inheritance">addr:* tag inheritance</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#search-name-processing">Search name processing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#address-processing">Address processing</a>
        <ul>
    <li class="toctree-l4"><a class="reference internal" href="#independent-places">Independent places</a>
    </li>
    <li class="toctree-l4"><a class="reference internal" href="#dependent-places">Dependent places</a>
    </li>
        </ul>
    </li>
        </ul>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Tokenizers/">Tokenizers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../ICU-Tokenizer-Modules/">Custom modules for ICU tokenizer</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Development-Environment/">Setup for Development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../Testing/">Testing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../data-sources/">External Data Sources</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Appendix</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-18/">Installation on Ubuntu 18</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-20/">Installation on Ubuntu 20</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../appendix/Install-on-Ubuntu-22/">Installation on Ubuntu 22</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Nominatim 4.2.4</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Developers Guide &raquo;</li>
      <li>Indexing</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/openstreetmap/Nominatim/edit/master/docs/develop/Indexing.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="indexing-places">Indexing Places<a class="headerlink" href="#indexing-places" title="Permanent link"></a></h1>
<p>In Nominatim, the word <strong>indexing</strong> refers to the process that takes the raw
OpenStreetMap data from the place table, enriches it with address information
and creates the search indexes. This section explains the basic data flow.</p>
<h2 id="initial-import">Initial import<a class="headerlink" href="#initial-import" title="Permanent link"></a></h2>
<p>After osm2pgsql has loaded the raw OSM data into the place table,
the data is copied to the final search tables placex and location_property_osmline.
While they are copied, some basic properties are added:</p>
<ul>
<li>country_code, geometry_sector and partition</li>
<li>initial search and address rank</li>
</ul>
<p>In addition the column <code>indexed_status</code> is set to <code>1</code> marking the place as one
that needs to be indexed.</p>
<p>All this happens in the triggers <code>placex_insert</code> and <code>osmline_insert</code>.</p>
<h2 id="indexing">Indexing<a class="headerlink" href="#indexing" title="Permanent link"></a></h2>
<p>The main work horse of the data import is the indexing step, where Nominatim
takes every place from the placex and location_property_osmline tables where
the indexed_status != 0 and computes the search terms and the address parts
of the place.</p>
<p>The indexing happens in three major steps:</p>
<ol>
<li>
<p><strong>Data preparation</strong> - The indexer gets the data for the place to be indexed
   from the database.</p>
</li>
<li>
<p><strong>Search name processing</strong> - The prepared data is given to the
   tokenizer which computes the search terms from the names
   and potentially other information.</p>
</li>
<li>
<p><strong>Address processing</strong> - The indexer then hands the prepared data and the
   tokenizer information back to the database via an <code>INSERT</code> statement which
   also sets the indexed_status to <code>0</code>. This triggers the update triggers
   <code>placex_update</code>/<code>osmline_update</code> which do the work of computing address
   parts and filling all the search tables.</p>
</li>
</ol>
<p>When computing the address terms of a place, Nominatim relies on the processed
search names of all the address parts. That is why places are processed in rank
order, from smallest rank to largest. To ensure correct handling of linked
place nodes, administrative boundaries are processed before all other places.</p>
<p>Apart from these restrictions, each place can be indexed independently
from the others. This allows a large degree of parallelization during the indexing.
It also means that the indexing process can be interrupted at any time and
will simply pick up where it left of when restarted.</p>
<h3 id="data-preparation">Data preparation<a class="headerlink" href="#data-preparation" title="Permanent link"></a></h3>
<p>The data preparation step computes and retrieves all data for a place that
might be needed for the next step of processing the search name. That includes</p>
<ul>
<li>location information (country code)</li>
<li>place classification (class, type, ranks)</li>
<li>names (including names of linked places)</li>
<li>address information (<code>addr:*</code> tags)</li>
</ul>
<p>Data preparation is implemented in pl/PgSQL mostly in the functions
<code>placex_indexing_prepare()</code> and <code>get_interpolation_address()</code>.</p>
<h4 id="addr-tag-inheritance"><code>addr:*</code> tag inheritance<a class="headerlink" href="#addr-tag-inheritance" title="Permanent link"></a></h4>
<p>Nominatim has limited support for inheriting address tags from a building
to POIs inside the building. This only works when the address tags are on the
building outline. Any rank 30 object inside such a building or on its outline
inherits all address tags when it does not have any address tags of its own.</p>
<p>The inheritance is computed in the data preparation step.</p>
<h3 id="search-name-processing">Search name processing<a class="headerlink" href="#search-name-processing" title="Permanent link"></a></h3>
<p>The prepared place information is handed to the tokenizer next. This is a
Python module responsible for processing the names  from both name and address
terms and building up the word index from them. The process is explained in
more detail in the <a href="../Tokenizers/">Tokenizer chapter</a>.</p>
<h3 id="address-processing">Address processing<a class="headerlink" href="#address-processing" title="Permanent link"></a></h3>
<p>Finally, the preprocessed place information and the results of the search name
processing are written back to the database. At this point the update trigger
of the placex/location_property_osmline tables take over and fill all the
dependent tables. This makes up the most work-intensive part of the indexing.</p>
<p>Nominatim distinguishes between dependent and independent places.
<strong>Dependent places</strong> are all places on rank 30: house numbers, POIs etc. These
places don't have a full address of their own. Instead they are attached to
a parent street or place and use the information of the parent for searching
and displaying information. Everything else are <strong>independent places</strong>: streets,
parks, water bodies, suburbs, cities, states etc.  They receive a full address
on their own.</p>
<p>The address processing for both types of places is very different.</p>
<h4 id="independent-places">Independent places<a class="headerlink" href="#independent-places" title="Permanent link"></a></h4>
<p>To compute the address of an independent place Nominatim searches for all
places that cover the place to compute the address for at least partially.
For places with an area, that area is used to check for coverage. For place
nodes an artificial square area is computed according to the rank of
the place. The lower the rank the lager the area. The <code>location_area_large_X</code>
tables are there to facilitate the lookup. All places that can function as
the address of another place are saved in those tables.</p>
<p><code>addr:*</code> and <code>isin:*</code> tags are taken into account to compute the address, too.
Nominatim will give preference to places with the same name as in these tags
when looking for places in the vicinity. If there are no matching place names
at all, then the tags are at least added to the search index. That means that
the names will not be shown in the result as the 'address' of the place, but
searching by them still works.</p>
<p>Independent places are always added to the global search index <code>search_name</code>.</p>
<h4 id="dependent-places">Dependent places<a class="headerlink" href="#dependent-places" title="Permanent link"></a></h4>
<p>Dependent places skip the full address computation for performance reasons.
Instead they just find a parent place to attach themselves to.</p>
<p><img alt="parenting of dependent places" src="../parenting-flow.svg" /></p>
<p>By default a POI
or house number will be attached to the closest street. That can be any major
or minor street indexed by Nominatim. In the default configuration that means
that it can attach itself to a footway but only when it has a name.</p>
<p>When the dependent place has an <code>addr:street</code> tag, then Nominatim will first
try to find a street with the same name before falling back to the closest
street.</p>
<p>There are also addresses in OSM, where the housenumber does not belong
to a street at all. These have an <code>addr:place</code> tag. For these places, Nominatim
tries to find a place with the given name in the indexed places with an
address rank between 16 and 25. If none is found, then the dependent place
is attached to the closest place in that category and the addr:place name is
added as <em>unlisted</em> place, which indicates to Nominatim that it needs to add
it to the address output, no matter what. This special case is necessary to
cover addresses that don't really refer to an existing object.</p>
<p>When an address has both the <code>addr:street</code> and <code>addr:place</code> tag, then Nominatim
assumes that the <code>addr:place</code> tag in fact should be the city part of the address
and give the POI the usual street number address.</p>
<p>Dependent places are only added to the global search index <code>search_name</code> when
they have either a name themselves or when they have address tags that are not
covered by the places that make up their address. The latter ensures that
addresses are always searchable by those address tags.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../Database-Layout/" class="btn btn-neutral float-left" title="Database Layout"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../Tokenizers/" class="btn btn-neutral float-right" title="Tokenizers">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/openstreetmap/Nominatim" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../Database-Layout/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../Tokenizers/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
